<!-- 无集群 -->
<#if response.notOK>
<div class="card mt-2">
	<div class="card-body">
		<form class="form-inline" role="form">
			<div class="form-group">
				<label for="mqClusterSelect"> 集群: 暂无数据 </label>
			</div>
		</form>
	</div>
</div>
<#else>
<div class="card mt-2">
	<div class="card-body">
		<style type="text/css">
			li#previous.disabled a {color:#CCC}
			li#next.disabled a {color:#CCC}
			pre {
				font-size: 11px;
				line-height: 1;
				padding: 0;
				margin: 0;
				border: 0;
				background-color: transparent;
				white-space: pre-wrap;
				overflow-y:hidden;
			}
			.fixedHeight {
				max-height: 400px;
				overflow-y: auto;
			}
			#theadTable tr td{
				border: 0px;
			}
			.tooltip-inner {
				max-width: 300px;
				text-align: left;
			}
		</style>
		<!--tree插件 -->
		<link href="${request.contextPath}/plugins/treetable/jquery.treetable.css" rel="stylesheet">
		<link href="${request.contextPath}/plugins/treetable/jquery.treetable.theme.default.css" rel="stylesheet">
		<script src="${request.contextPath}/plugins/treetable/jquery.treetable.js"></script>
		<!-- 有集群 -->
		<div class="input-group">
			<label for="mqClusterSelect" class="col-form-label"> 集群: </label>
			<div class="ml-1 mr-1">
				<select name="type" id="mqClusterSelect" class="selectpicker form-control border">
					<#list response.result.mqCluster as mqCluster>
						<option value="${mqCluster.id}" <#if mqCluster.id == response.result.selectedMQCluster.id>selected="selected"</#if>>${mqCluster.name}</option>
					</#list>
				</select>
			</div>
			<div class="btn-group">
				<#if response.result.hasNameServer>
					<button type="button" class="btn btn-default" onclick="addBroker()" title="新建Master" data-target="#addBrokerModal" data-toggle="modal"><span class="fas fa-plus"></span><span class="d-none d-lg-inline">Master</span></button>
				</#if>
				<button type="button" class="btn btn-default dropdown-toggle dropdown-hover dropdown-icon" data-toggle="dropdown">
					<#if response.result.hasNameServer>
						<span class="sr-only">Toggle Dropdown</span>
					<#else>
						操作
					</#if>
				</button>
				<div class="dropdown-menu" role="menu">
					<#if response.result.hasNameServer>
					<a class="dropdown-item" href="#" title="添加broker节点后，从Name Server抓取broker列表，刷入数据库中，用于broker列表展示及监控" onclick="refresh()" data-toggle="modal"><span class="fas fa-sync-alt fa-fw"></span>&nbsp;刷新集群</a>
					<div class="dropdown-divider"></div>
					</#if>
					<a class="dropdown-item" href="#" title="将broker数据迁移至远程机器" onclick="migrateBrokerData()" data-target="#migrateBrokerDataModal" data-toggle="modal"><i class="fa-solid fa-copy fa-fw"></i></span>&nbsp;迁移数据</a>
					<#if response.result.brokerGroup??>
					<div class="dropdown-divider"></div>
					<a class="dropdown-item" href="#" data-placement="bottom" title="该功能用于将已有RocketMQ集群的topic写入topic表中（可以执行多次，因为数据库有唯一索引）。" onclick="initTopic()" data-toggle="modal"><i class="fa-solid fa-download fa-fw"></i>&nbsp;初始化Topic</a>
					<a class="dropdown-item" href="#" data-placement="bottom" title="该功能用于将已有RocketMQ集群的topic的在线消费者写入consumer表中（可以执行多次，因为数据库有唯一索引）。" onclick="initConsumer()" data-toggle="modal"><i class="fa-solid fa-download fa-fw"></i>&nbsp;初始化Consumer</a>
					</#if>
				</div>
			</div>
		</div>
	</div>
</div>
<div class="card mt-2">
	<div class="card-body table-responsive p-0">
		<table class="table table-hover text-nowrap">
			<thead>
				<tr>
					<td>Broker名字</td>
					<td>ID</td>
					<td>地址</td>
					<td data-toggle="tooltip" title="单位:秒">生产</td>
					<td data-toggle="tooltip" title="单位:秒">消费</td>
					<td data-toggle="tooltip" title="定时消息量,5.x支持的特性">定时</td>
					<td data-toggle="tooltip" title="延时消息量">延时</td>
					<td data-toggle="tooltip" title="slave的commitlog落后于master多少">落后量</td>
					<td>版本</td>
					<td data-toggle="tooltip" title="MQCloud会定时监控broker是否存活">状态</td>
					<td>监控时间</td>
					<td>操作</td>
				</tr>
			</thead>
			<tbody>
				<#if response.result.brokerGroup??>
				<#assign brokerGroup=response.result.brokerGroup />
				<#assign i = 0>
				<#list brokerGroup?keys as key>
					<#assign rowspaned = false>
					<#list brokerGroup[key]?keys as bkey>
						<tr>
							<#assign i = i + 1>
							<#if !rowspaned>
								<#if bkey == "0">
									<td rowspan=${brokerGroup[key]?size}><a onclick="showBrokerStoreStatModal('${brokerGroup[key][bkey].brokerAddr}')" data-toggle="tooltip" title="查看master存储性能" href="#">${key}</a></td>
								<#else>
									<td rowspan=${brokerGroup[key]?size}>${key}</td>
								</#if>
								<#assign rowspaned = true>
							</#if>
							<#if bkey == "0">
								<td><a href='#' onclick="setIp('${brokerGroup[key][bkey].brokerAddr}')" data-target="#brokerTrafficModal" data-toggle="modal" title="查看master流量">${bkey}</a></td>
							<#else>
								<td class="border-top-0 pt-0" style="padding-left: 12px;">${bkey}</td>
							</#if>
							<td <#if bkey != "0">class="border-top-0 pt-0"</#if>><a href="#" onclick="showBrokerConfigModal('${brokerGroup[key][bkey].brokerAddr}')" data-toggle="tooltip" title="线上配置">${brokerGroup[key][bkey].brokerAddr}</a></td>
							<td <#if bkey != "0">class="border-top-0 pt-0"</#if>>
								<#if brokerGroup[key][bkey].inTps??>${brokerGroup[key][bkey].inTps}</#if>
							</td>
							<td <#if bkey != "0">class="border-top-0 pt-0"</#if>>
								<#if brokerGroup[key][bkey].outTps??>${brokerGroup[key][bkey].outTps}</#if>
							</td>
							<td <#if bkey != "0">class="border-top-0 pt-0"</#if>>
								<a href="#" data-target="#timerWheelMetricsModal" data-toggle="modal" onclick="timerWheelMetrics('${brokerGroup[key][bkey].brokerAddr}')"><span data-toggle="tooltip" data-html="true" title="时间轮写入吞吐(timerEnqueueTps):${brokerGroup[key][bkey].timerEnqueueTpsFormat!}<br>commitlog写入吞吐(timerDequeueTps):${brokerGroup[key][bkey].timerDequeueTpsFormat!}<br>消费时间轮topic落后量(timerOffsetBehind):${brokerGroup[key][bkey].timerOffsetBehind!}<br>时间轮转动落后时间(timerReadBehind):${brokerGroup[key][bkey].timerReadBehind!}ms">${brokerGroup[key][bkey].timerCongestNum!}</span></a>
							</td>
							<#if bkey == "0">
								<td>
								<#if brokerGroup[key][bkey].delayQueue??>
									<a href="#" data-target="#delayMessageOffsetModal${i}" data-toggle="modal" title="查看延迟队列数据">
									${brokerGroup[key][bkey].delayQueue.delayMessageOffset}
								<#else>
									0
								</#if>
								<#if brokerGroup[key][bkey].delayQueue??>
									</a>
								</#if>
								</td>
								<td>0</td>
							<#else>
								<td class="border-top-0 pt-0" data-toggle="tooltip" title="由于slave不会处理延时队列的消息，故一直为0">0</td>
								<#if brokerGroup[key]["0"]??>
									<#assign fallbehindSize=brokerGroup[key]["0"].commitLogMaxOffset - brokerGroup[key][bkey].commitLogMaxOffset />
									<td class="border-top-0 pt-0" data-toggle="tooltip" title="${fallbehindSize}">${brokerGroup[key]["0"].format(fallbehindSize)}</td>
								<#else>
									<td data-toggle="tooltip">0</td>
								</#if>
							</#if>
							<td <#if bkey != "0">class="border-top-0 pt-0"</#if>>
								<#if brokerGroup[key][bkey].version??>${brokerGroup[key][bkey].version}</#if>
							</td>
							<td <#if bkey != "0">class="border-top-0 pt-0"</#if>>
								<#if brokerGroup[key][bkey].checkStatus == 2>
									<font style='font-weight:bold' color='red'>${brokerGroup[key][bkey].checkStatusDesc}</font>
								<#else>
									${brokerGroup[key][bkey].checkStatusDesc}
								</#if>
							</td>
							<td class="text-wrap <#if bkey != "0">border-top-0 pt-0</#if>">
								<#if brokerGroup[key][bkey].checkTime??>${brokerGroup[key][bkey].checkTime}</#if>
							</td>
							<td <#if bkey != "0">class="border-top-0 pt-0"</#if>>
								<#if brokerGroup[key][bkey].info??>
									<button data-target="#clusterInfoModal${i}" data-toggle="modal" type="button" class="btn btn-xs btn-info" title="查看当前broker的其他状态信息"><span class="fas fa-eye" aria-hidden="true"></span></button>
								</#if>
								<#if brokerGroup[key][bkey].version?? && bkey == "0">
									<button title="查看broker限速详情" data-toggle="modal" class="btn btn-xs btn-secondary" onclick="brokerRateLimitModalShow('${brokerGroup[key][bkey].brokerAddr}')"><i class="fa-solid fa-fw fa-gauge"></i></button>
								</#if>
								<#if brokerGroup[key][bkey].version??>
								<#if bkey == "0">
									<#if brokerGroup[key][bkey].writable>
										<button title="禁止客户端写入，broker下线前需要先禁止写入，等没有人写入后，再下线" type="button" onclick="program('${brokerGroup[key][bkey].brokerAddr}', 'program${i}')" class="btn btn-xs btn-warning" data-target="#nowriteModal${i}" data-toggle="modal">停写</button>
									<#else>
										<button title="恢复写入" type="button" onclick="program('${brokerGroup[key][bkey].brokerAddr}', 'program${i}')" class="btn btn-xs btn-info" data-target="#nowriteModal${i}" data-toggle="modal">恢复</button>
									</#if>
									<button title="已经停写的broker，可以进行关闭操作" type="button" class="btn btn-xs btn-danger" data-target="#brokerOfflineModal${i}" onclick="program('${brokerGroup[key][bkey].brokerAddr}', 'brokerOfflineProgram${i}')" data-toggle="modal">下线</button>
									<div class="d-inline-flex">
										<button title="增加slave" type="button" class="btn btn-xs btn-primary"  onclick="addBroker('${key}', '${brokerGroup[key][bkey].version}')" data-target="#addBrokerModal" data-toggle="modal"><span class="fas fa-plus" aria-hidden="true"></span></button>
									</div>
								<#else>
									<button title="slave可以直接进行关闭" type="button" class="btn btn-xs btn-danger" data-target="#brokerOfflineModal${i}" onclick="program('${brokerGroup[key][bkey].brokerAddr}', 'brokerOfflineProgram${i}')" data-toggle="modal">下线</button>
								</#if>
								<#else>
									<button title="启动broker" data-toggle="tooltip" type="button" id="${key}<#if bkey != "0">-s</#if>Btn" class="btn btn-xs btn-info" onclick="startupBroker('${brokerGroup[key][bkey].brokerAddr}', '${key}<#if bkey != "0">-s</#if>', '${brokerGroup[key][bkey].baseDir!}')">启动</button>
									<button title="在当前机器更新broker并保留数据" type="button" class="btn btn-xs btn-info"  onclick="upgradeBroker('${brokerGroup[key][bkey].brokerAddr}', '${key}<#if bkey != "0">-s${bkey}</#if>', '${brokerGroup[key][bkey].baseDir!}')" data-target="#upgradeBrokerModal" data-toggle="modal">升级</button>
									<button title="将当前机器broker数据迁移至远程机器" type="button" class="btn btn-xs btn-info"  onclick="migrateBrokerData('${brokerGroup[key][bkey].brokerAddr}', '${brokerGroup[key][bkey].baseDir!}')" data-target="#migrateBrokerDataModal" data-toggle="modal">数据迁移</button>
								</#if>
							</td>
						</tr>
					</#list>
				</#list>
				<#else>
					<tr>
						<td colspan=11 class="text-center">暂无数据</td>
					</tr>
				</#if>
			</tbody>
		</table>
	</div>
</div>
<!-- 	准备搜索部分 -->
<div class="row">
	<div class="col-md-12">
		<div style="float:left;margin:10px 5px;"><h5><b>${response.result.selectedMQCluster.name}</b> 流量图</h5></div>
		<div id="cluster_search" style="float:right;margin:10px 0px;"></div>
	</div>
</div>
<!-- 	准备曲线图 -->
<div id="cluster_lineChart"><center>暂无数据</center></div>
<!-- 	模态框 -->
<#if response.result.brokerGroup??>
	<#assign brokerGroup=response.result.brokerGroup />
	<#assign i = 0>
	<#list brokerGroup?keys as key>
		<#assign rowspaned = false>
		<#list brokerGroup[key]?keys as bkey>
			<#assign i = i + 1>
			<#if brokerGroup[key][bkey].info??>
				<div id="clusterInfoModal${i}" class="modal fade" tabindex="-1" data-width="400" aria-hidden="true">
					<div class="modal-dialog modal-lg">
						<div class="modal-content">
							<div class="modal-header">
								<h4 class="modal-title">其余信息展示</h4>
								<button type="button" class="close" data-dismiss="modal"
										aria-hidden="true">&times;</button>
							</div>
							<div class="table-responsive p-0">
								<table class="table text-nowrap">
									<thead>
										<tr>
											<th>指标项</th>
											<th>值</th>
										</tr>
									</thead>
									<tbody>
										<#list brokerGroup[key][bkey].info?keys as ikey>
										<tr>
											<td>${ikey}</td>
											<td class="text-wrap">
												${brokerGroup[key][bkey].info[ikey]}
											</td>
										<tr>
										</#list>
									</tbody>
								</table>
							</div>	
						</div>
					</div>
				</div>
			</#if>
			<#if bkey == "0" && brokerGroup[key][bkey].delayQueue??>
				<div id="delayMessageOffsetModal${i}" class="modal fade" tabindex="-1" data-width="400" aria-hidden="true">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<h4 class="modal-title">${brokerGroup[key][bkey].brokerAddr}延迟队列数据</h4>
								<button type="button" class="close" data-dismiss="modal"
										aria-hidden="true">&times;</button>
							</div>
							<div class="modal-body">
								<div class="card">
									<div class="card-body table-responsive p-0">
										<table class="table table-striped table-hover" style="margin-top: 0px">
											<thead>
												<tr>
													<th>延时级别</th>
													<th>当前偏移量</th>
													<th>最大偏移量</th>
													<th>消息量</th>
												</tr>
											</thead>
											<tbody>
											<#list brokerGroup[key][bkey].delayQueue.delayQueueOffsetList as offset>
												<tr>
													<td>${offset.messageDelayLevel.time}</td>
													<td>
														${offset.curOffset}
													</td>
													<td>
														${offset.maxOffset}
													</td>
													<td>
														<#assign minus = offset.maxOffset - offset.curOffset>
														<#if minus gt 0><a href="#" onclick="showDelayMessageModal('${offset.messageDelayLevel.time}', ${offset.curOffset}, ${offset.maxOffset}, '${key}', ${offset.messageDelayLevel.level-1})" data-toggle="tooltip" title="查看消息"></#if>
														${minus}
														<#if minus gt 0></a></#if>
													</td>
												<tr>
											</#list>
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</#if>
			<#if brokerGroup[key][bkey].version?? && bkey == "0">
				<!-- 停写 -->
			<div id="nowriteModal${i}" class="modal fade" tabindex="-1" data-width="400">
				<div class="modal-dialog modal-xl">
					<div class="modal-content">
						<div class="modal-header">
							<h4 class="modal-title">确定要<#if brokerGroup[key][bkey].writable>停止<#else>恢复</#if>写入?</h4>
							<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						</div>
						<form class="form-horizontal form-bordered form-row-stripped" id="nowrite${i}">
							<div class="modal-body">
								<div class="row">
									<div class="col-md-12">
										<div class="form-body">
											<div class="form-group row justify-content-center">
												<label class="col-form-label col-md-1"> broker: </label>
												<div class="col-md-10">
													<input type="text" name="broker" value="${key}" class="form-control" readonly />
												</div>
											</div>
											<div class="form-group row justify-content-center">
												<label class="col-form-label col-md-1"> 进程: </label>
												<div class="col-md-10">
													<textarea id="program${i}" type="text" name="info" rows="10" class="form-control" readonly></textarea>
												</div>
											</div>
											<input type="hidden" name="cid" value="${response.result.selectedMQCluster.id}">
											<input type="hidden" name="addr" value="${brokerGroup[key][bkey].brokerAddr}">
										</div>
									</div>
								</div>
							</div>
							<div class="modal-footer">
								<button type="button" data-dismiss="modal" class="btn btn-light" >取消</button>
								<#if brokerGroup[key][bkey].writable>
								<button type="button" class="btn btn-primary" onclick="nowrite('nowrite${i}')" id="nowrite${i}Btn">确定</button>
								<#else>
								<button type="button" class="btn btn-primary" onclick="resumeWrite('nowrite${i}')" id="nowrite${i}Btn">确定</button>
							</#if>
					</div>
					</form>
				</div>
			</div></div>
			</#if>
			<!-- 下线 -->
			<div id="brokerOfflineModal${i}" class="modal fade" tabindex="-1" data-width="400">
				<div class="modal-dialog modal-xl">
					<div class="modal-content">
						<div class="modal-header">
							<h4 class="modal-title">确定要下线broker?</h4>
							<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						</div>
						<form class="form-horizontal form-bordered form-row-stripped" id="brokerOffline${i}">
							<input type="hidden" name="cid" value="${response.result.selectedMQCluster.id}">
							<div class="modal-body">
								<div class="row">
									<div class="col-md-12">
										<div class="form-body">
											<div class="form-group row justify-content-center">
												<label class="col-form-label col-md-1"> 地址: </label>
												<div class="col-md-10">
													<input type="text" name="addr" value="${brokerGroup[key][bkey].brokerAddr}" class="form-control" readonly />
												</div>
											</div>
											<div class="form-group  row justify-content-center">
												<label class="col-form-label col-md-1"> 进程: </label>
												<div class="col-md-10">
													<textarea id="brokerOfflineProgram${i}" type="text" rows="10" class="form-control" readonly></textarea>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="modal-footer">
								<button type="button" data-dismiss="modal" class="btn btn-light" >取消</button>
								<button type="button" class="btn btn-primary" onclick="brokerOffline('brokerOffline${i}')" id="brokerOffline${i}Btn">确定</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</#list>
	</#list>
</#if>
	

<!-- 新建broker -->
<div id="addBrokerModal" class="modal fade" tabindex="-1">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title">新建Broker</h4>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body">
				<div class="sw sw-justified" id="addNewBroker">
					<ul class="nav nav-progress">
						<li class="nav-item">
							<a class="nav-link default" href="#step-1">
								<div class="num">1</div>
								<div style="font-size: small; font-weight: bold">服务器选择</div>
								<span style="font-size: small;color: #0b2e13;">broker安装到哪</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link default" href="#step-2">
								<div class="num">2</div>
								<div style="font-size: small; font-weight: bold">JDK校验</div>
								<span style="font-size: small;color: #0b2e13;">校验jdk是否配置完成，版本要求>=1.8</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link default" href="#step-3">
								<div class="num">3</div>
								<div style="font-size: small; font-weight: bold">端口校验</div>
								<span style="font-size: small;color: #0b2e13;">检查端口是否被占用</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link default" href="#step-4">
								<div class="num">4</div>
								<div style="font-size: small; font-weight: bold">目录校验</div>
								<span style="font-size: small;color: #0b2e13;">检查安装目录是否被占用</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link default" href="#step-5">
								<div class="num">5</div>
								<div style="font-size: small; font-weight: bold">下载安装包</div>
								<span style="font-size: small;color: #0b2e13;">从仓库下载安装包到服务器/tmp下</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link default" href="#step-6">
								<div class="num">6</div>
								<div style="font-size: small; font-weight: bold">解压</div>
								<span style="font-size: small;color: #0b2e13;">解压到安装目录下</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link default" href="#step-7">
								<div class="num">7</div>
								<div style="font-size: small; font-weight: bold">生成配置文件</div>
								<span style="font-size: small;color: #0b2e13;">生成mq.conf,run.sh和topic配置</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link default" href="#step-8">
								<div class="num">8</div>
								<div style="font-size: small; font-weight: bold">初始化配置</div>
								<span style="font-size: small;color: #0b2e13;">执行os.sh</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link default" href="#step-9">
								<div class="num">9</div>
								<div style="font-size: small; font-weight: bold">启动</div>
								<span style="font-size: small;color: #0b2e13;">启动broker</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link default" href="#step-10">
								<div class="num">10</div>
								<div style="font-size: small; font-weight: bold">完成</div>
								<span style="font-size: small;color: #0b2e13;">获取启动后的进程信息</span>
							</a>
						</li>
					</ul>
					<div class="tab-content"></div>
				</div>
				<form class="form-horizontal form-bordered form-row-stripped mt-2" id="broker">
					<div class="form-group row justify-content-center">
						<label class="col-md-2"> RocketMQ版本: </label>
						<div class="col-md-8 checkbox-inline">
							<label>
								<input type="radio" id="version_4" name="v" value="4" onclick="hideProxyInput()">4.x
							</label>&nbsp;&nbsp;
							<label>
								<input type="radio" id="version_5" name="v" value="5" checked onclick="showProxyInput()">5.x
							</label>
							&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
							<label id="proxyInput" style="display: none"><input name="enableProxy" type="checkbox">启用Proxy</label>
						</div>
					</div>
					<div class="form-body">
						<div class="form-group row justify-content-center">
							<label class="col-form-label col-md-2"> 服务器: </label>
					        <div class="col-md-8">
								<select id="brokerServerSelect" class="form-control selectpicker border" title="请选择" data-live-search-placeholder="搜索" name="ip" data-live-search="true"></select>
							</div>
						</div>
						<div class="form-group row justify-content-center">
							<label class="col-form-label col-md-2"> jvm内存: </label>
							<div class="col-md-8">
								<input type="text" id="jvmOptExt" name="jvmOptExt" value="" placeholder="-Xms8g -Xmx8g -XX:MaxDirectMemorySize=15g" data-toggle="tooltip" title="不填将会保持默认配置" class="form-control" />
							</div>
						</div>
						<div class="form-group row justify-content-center">
							<label class="col-form-label col-md-2"> 所属集群: </label>
					        <div class="col-md-8">
								<input type="text" value="${response.result.selectedMQCluster.name}" class="form-control" readonly/>
							</div>
						</div>
						<div class="form-group row justify-content-center">
							<label class="col-form-label col-md-2" data-toggle="tooltip" title="安装broker的绝对路径(不包含broker自身)"> 安装路径: </label>
					        <div class="col-md-8">
								<input type="text" id="baseDir" name="baseDir" value="/opt/mqcloud/" class="form-control"/>
							</div>
						</div>
						<div class="form-group row justify-content-center">
							<label class="col-form-label col-md-2"> 进程: </label>
					        <div class="col-md-8">
								<textarea id="brokerProgramInfo" type="text" rows="1" class="form-control" readonly></textarea>
							</div>
						</div>
						<div class="form-group row justify-content-center">
							<label class="col-form-label col-md-2"> 提示: </label>
					        <div class="col-md-8">
								<div class="form-control-static">如果安装遇到错误警告，请解决后再点<b>继续</b>执行。实际安装路径:<b id="realPath"></b></div>
							</div>
						</div>
					</div>
					<input type="hidden" id="dir" name="dir" value=""/>
					<div class="card">
						<div class="card-body table-responsive" style="padding: 0px;">
							<table class="table table-bordered text-nowrap text-sm" style="table-layout: fixed;word-break:break-all; word-wrap:break-word">
								<colgroup>
									<col width="100px">
									<col width="250px">
									<col width="200px">
									<col width="100px">
									<col width='300px'>
									<col width='60px'>
								</colgroup>
								<thead>
									<tr>
										<th>分组</th>
										<th>key</th>
										<th>线上值</th>
										<th>默认值</th>
										<th>描述</th>
										<th data-toggle="tooltip" title="修改后需要重启则表示不支持动态修改，反之则支持">动改</th>
									</tr>
								</thead>
								<tbody id="clusterConfigBody">
								</tbody>
							</table>
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" id="installBtn" data-toggle="modal" onclick="install('broker')"><span id="brokerInstall">一键安装</span></button>
			</div>
		</div>
	</div>
</div>

<!-- 升级部署broker -->
<div id="upgradeBrokerModal" class="modal fade" tabindex="-1">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title">升级Broker</h4>
				<b  style="font-size:9px;margin-top: 13px;margin-left: 5px"><i>请提前在通用配置里rocketmqFilePath配置项, 配置好待升级的安装包地址。如需修改broker配置,请在升级完毕后进行修改。</i></b>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body">
				<div class="sw sw-justified" id="updateBroker">
					<ul class="nav nav-progress">
						<li class="nav-item">
							<a class="nav-link default" href="#step-1">
								<div class="num">1</div>
								<div style="font-size: small; font-weight: bold">备份数据</div>
								<span style="font-size: small;color: #0b2e13;">备份原安装目录</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link default" href="#step-2">
								<div class="num">2</div>
								<div style="font-size: small; font-weight: bold">下载安装包</div>
								<span style="font-size: small;color: #0b2e13;">从仓库下载最新安装包到服务器/tmp下</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link default" href="#step-3">
								<div class="num">3</div>
								<div style="font-size: small; font-weight: bold">解压</div>
								<span style="font-size: small;color: #0b2e13;">解压到安装目录下</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link default" href="#step-4">
								<div class="num">4</div>
								<div style="font-size: small; font-weight: bold">恢复数据</div>
								<span style="font-size: small;color: #0b2e13;">移动备份数据和配置文件至新的安装目录</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link default" href="#step-5">
								<div class="num">5</div>
								<div style="font-size: small; font-weight: bold">启动</div>
								<span style="font-size: small;color: #0b2e13;">启动broker</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link default" href="#step-6">
								<div class="num">6</div>
								<div style="font-size: small; font-weight: bold">完成</div>
								<span style="font-size: small;color: #0b2e13;">获取启动后的进程信息</span>
							</a>
						</li>
					</ul>
					<div class="tab-content"></div>
				</div>
				<form class="form-horizontal form-bordered form-row-stripped" id="upgradeBroker">
					<div class="form-body">
						<div class="form-group row justify-content-center">
							<label class="col-form-label col-md-2"> 机器: </label>
							<div class="col-md-5">
								<input type="text" id="upgradeBrokerAddr" name="ipAddr" class="form-control" readonly/>
							</div>
						</div>
						<div class="form-group row justify-content-center">
							<label class="col-md-2"> RocketMQ版本: </label>
							<div class="col-md-5 checkbox-inline">
								<label>
									<input type="radio" name="v" value="4">4.x
								</label>&nbsp;&nbsp;
								<label>
									<input type="radio" name="v" value="5" checked>5.x
								</label>
							</div>
						</div>
						<div class="form-group row justify-content-center">
							<label class="col-form-label col-md-2"> brokerName: </label>
							<div class="col-md-5">
								<input type="text" id="upgradeBrokerName" name="brokerName" class="form-control" readonly/>
							</div>
						</div>
						<div class="form-group row justify-content-center">
							<label class="col-form-label col-md-2"> 所属集群: </label>
							<div class="col-md-5">
								<input type="text" value="${response.result.selectedMQCluster.name}" class="form-control" readonly/>
							</div>
						</div>
						<div class="form-group row justify-content-center">
							<label class="col-form-label col-md-2"> 进程: </label>
							<div class="col-md-5">
								<textarea id="upgradeBrokerProgramInfo" type="text" rows="1" class="form-control" readonly></textarea>
							</div>
						</div>
						<div class="form-group row justify-content-center">
							<label class="col-form-label col-md-2"> 提示: </label>
							<div class="col-md-5">
								<div class="form-control border-0">如果升级过程遇到错误警告，请登录服务器解决后再<b>继续</b>执行</div>
							</div>
						</div>
					</div>
					<input type="hidden" id="upgradeDir" name="dir" value=""/>
					<input type="hidden" id="upgradeBrokerIp" name="ip" value=""/>
					<input type="hidden" id="upgradeBrokerListenPort" name="listenPort" value=""/>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" id="upgradeBtn" data-toggle="modal" onclick="upgrade('upgradeBroker')"><span id="upgradeBrokerKey">一键升级</span></button>
			</div>
		</div>
	</div>
</div>

<!-- 迁移broker数据 -->
<div id="migrateBrokerDataModal" class="modal fade" tabindex="-1" data-backdrop="static" data-keyboard="false">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title" style="display:inline-block">迁移Broker数据</h4> 
				<b style="font-size:9px;margin-top: 13px;margin-left: 5px"><i>1.源broker请停写；2.目标broker部署好，但请勿启动。</i></b>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body">
				<div class="sw sw-justified" id="migrateToBroker">
					<ul class="nav nav-progress">
						<li class="nav-item">
							<a class="nav-link default" href="#step-1">
								<div class="num">1</div>
								<div style="font-size: small; font-weight: bold">服务器选择</div>
								<span style="font-size: small;color: #0b2e13;">选择目标服务器</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link default" href="#step-2">
								<div class="num">2</div>
								<div style="font-size: small; font-weight: bold">目录校验</div>
								<span style="font-size: small;color: #0b2e13;">确保目标目录存在</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link default" href="#step-3">
								<div class="num">3</div>
								<div style="font-size: small; font-weight: bold">创建存储目录</div>
								<span style="font-size: small;color: #0b2e13;">在目标机器创建数据存储目录</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link default" href="#step-4">
								<div class="num">4</div>
								<div style="font-size: small; font-weight: bold">机器互信</div>
								<span style="font-size: small;color: #0b2e13;">源机器与目标机器互信</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link default" href="#step-5">
								<div class="num">5</div>
								<div style="font-size: small; font-weight: bold">源broker数据</div>
								<span style="font-size: small;color: #0b2e13;">获取源broker存储数据</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link default" href="#step-6">
								<div class="num">6</div>
								<div style="font-size: small; font-weight: bold">数据传输</div>
								<span style="font-size: small;color: #0b2e13;">将源broker存储数据传输至目标broker</span>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link default" href="#step-7">
								<div class="num">7</div>
								<div style="font-size: small; font-weight: bold">完成</div>
							</a>
						</li>
					</ul>
					<div class="tab-content"></div>
				</div>
	            <div class="card">
					<div class="card-header">
						<h5>一：配置目标机器及目录</h5>
					</div>
					<div class="card-body">
						<form id="migrateForm" class="form-inline form-bordered form-row-stripped">
							<div class="form-inline">
								<div class="form-group ml-2" style="width: 200px">
									<label class="d-block"> 源机器: </label>
									<div>
										<select id="sourceIp" class="selectpicker border form-control" title="请选择" data-live-search-placeholder="搜索" name="sourceIp" data-live-search="true"></select>
									</div>
								</div>
								<div class="form-group ml-2" style="width: 200px">
									<label> 源broker绝对路径: </label>
									<div>
										<input type="text" id="sourceHome" name="sourceHome" class="form-control"/>
									</div>
								</div>
								<div class="form-group ml-2" style="width: 200px">
									<label> 目标机器: </label>
									<div>
										<select id="destIp" class="selectpicker border form-control" title="请选择" data-live-search-placeholder="搜索" name="destIp" data-live-search="true"></select>
									</div>
								</div>
								<div class="form-group ml-2" style="width: 200px">
									<label> 目标broker绝对路径: </label>
									<div>
										<input type="text" id="destHome" name="destHome" class="form-control"/>
									</div>
								</div>
							</div>
						</form>
					</div>
				</div>
				<div class="card">
					<div class="card-header">
						<h5>二：迁移数据文件</h5>
					</div>
					<div class="card-body table-responsive">
						<table id="theadTable" class="treetable" style="margin-bottom: 0px;">
							<colgroup>
								<col>
								<col width="50px">
								<col width="70px">
								<col width="67px">
								<col width="65px">
							</colgroup>
							<thead>
							  <tr>
								<th>数据文件</th>
								<th data-toggle="tooltip" title="文件夹大小为其下文件大小之和">大小</th>
								<th data-toggle="tooltip" title="标识文件是否传输成功">传输状态</th>
								<th data-toggle="tooltip" title="标识源文件和目标文件md5是否一致">md5校验</th>
								<th data-toggle="tooltip" title="标识源文件和目标文件大小是否一致，若md5一致则不校验大小">大小校验</>
							  </tr>
							</thead>
						</table>
						<div id="migrateDiv" class="fixedHeight">
							<table id="migrateTable" class="table table-striped table-hover treetable" style="margin-top: 0px">
								<colgroup>
									<col>
									<col width="50px">
									<col width="70px">
									<col width="67px">
									<col width="65px">
								</colgroup>
								<tbody>
								  <tr>
									<td colspan=5 class="text-center">暂无数据</td>
								  </tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" id="migrateBtn" data-toggle="modal" onclick="migrate()">一键迁移</button>
			</div>
		</div>
	</div>
</div>

<!-- broker统计 -->
<div id="brokerTrafficModal" class="modal fade" tabindex="-1" data-width="400">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<div class="modal-header d-lg-none">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body" style="padding-top:5px;">
				<div id="brokerTrafficChart"></div>
			</div>
		</div>
	</div>
</div>

<!-- 初始化结果 -->
<div id="initModal" class="modal fade" tabindex="-1" data-width="400">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title"><span id="initDiv">topic</span>初始化结果</h4>
				<button type="button" class="close" data-dismiss="modal"
					aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body" id="initBody">
			</div>
		</div>
	</div>
</div>

<!-- 消息查询 -->
<div id="delayMessageModal" class="modal fade">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title">延迟<span id="delayLevel"></span>队列消息查询</h4>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body">
				<div class="card">
					<div class="card-header">
						<form class="row" id="msgSearchForm">
							<!-- 偏移量查询 -->
							<div class="input-group offset col-md-4 mb-1">
								<label for="offsetStart" class="col-form-label"> 起始偏移量: </label>
								<input id="offsetStart" name="offsetStart" type="text" class="form-control" style="width:120px;">
							</div>
							<div class="input-group offset col-md-4 mb-1">
								<label for="offsetEnd" class="col-form-label"> 结束偏移量: </label>
								<input id="offsetEnd" name="offsetEnd" type="text" class="form-control" style="width:120px;">
							</div>
							<div class="col-md-4">
								<button type="button" onclick="searchOffsetMessage(false)" class="btn btn-search offset"><i class="fa fa-search"></i></button>
							</div>
							<input type="hidden" id="append" name="append" value="false">
							<input type="hidden" id="toBrokerName" name="toBrokerName">
							<input type="hidden" id="toQueue" name="toQueue">
							<input type="hidden" id="messageParam" name="messageParam" value="${messageQueryCondition.serialize()}">
						</form>
					</div>
					<div class="card-body table-responsive p-0">
						<table id="dataTable" class="table table-striped table-hover" style="table-layout: fixed">
							<colgroup>
								<col width="70px">
								<col width="200px">
								<col width="130px">
								<col width="120px">
								<col width="100px">
								<col width="300px">
								<col width="120px">
							</colgroup>
							<thead>
							<tr>
								<td>序号</td>
								<td>topic</td>
								<td>客户端</td>
								<td>发送时间</td>
								<td>broker:队列</td>
								<td>消息</td>
								<td id="keysTD">keys</td>
							</tr>
							</thead>
							<tbody>
							<tr class="no_more_data"><td colspan=8 class="text-center">暂无数据</td></tr>
							</tbody>
						</table>
					</div>
					<div class="card-footer">
						<div class="d-flex justify-content-between">
							<button id="previous" class=" previous btn btn-outline-primary btn-xs" title="上一页" data-toggle="tooltip" onclick="previous()"><i class="fas fa-backward"></i></button>
							<div class="text-primary text-sm">第<b id="pageNum"></b>页，命中数：<b id="sizeNum"></b>，检索数：<b id="searchNum"></b><span class="d-none d-lg-inline">，预估剩余数：<b id="leftNum"></b></span></div>
							<button id="next" class="next btn btn-outline-primary btn-xs" title="下一页" data-toggle="tooltip" onclick="next()"><i class="fas fa-forward"></i></button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- broker性能状态 -->
<div id="brokerStoreStatModal" class="modal fade" tabindex="-1" data-width="400">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title"><span id="ipBroker"></span>存储性能统计</h4>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body" style="padding-top:5px;">
				<!-- 	准备搜索部分 -->
				<div class="row">
					<div class="col-md-12">
						<div id="broker_store_search" style="float:right;margin:10px 0px;"></div>
					</div>
				</div>
				<!-- 	准备曲线图 -->
				<div id="broker_store_lineChart"><center>暂无数据</center></div>
			</div>
		</div>
	</div>
</div>

<!-- broker配置 -->
<div id="brokerConfigModal" class="modal fade" tabindex="-1" data-width="400">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title"><span id="brokerAddr"></span>线上配置</h4>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="table-responsive p-0">
				<table id="brokerConfigTable" class="table table-striped table-bordered text-nowrap text-sm">
					<colgroup>
						<col width="100px">
						<col width="280px">
						<col width="250px">
						<col>
						<col width='46px'>
					</colgroup>
					<thead>
					<tr>
						<th>分组</th>
						<th>key</th>
						<th>线上值</th>
						<th>描述</th>
						<th data-toggle="tooltip" title="修改后需要重启则表示不支持动态修改，反之则支持">动改</th>
					</tr>
					</thead>
					<tbody id="brokerConfigBody">
					<tr class="no_more_data"><td colspan=7 class="text-center">暂无数据</td></tr>
					</tbody>
				</table>
			</div>
			<div class="modal-footer">
				<button type="button" data-dismiss="modal" class="btn btn-light" >取消</button>
				<button type="submit" class="btn btn-primary" onclick="modifyBrokerConfig()" data-toggle="tooltip" title="注意：此更新仅对当前broker有效！" id="modifyBrokerConfigBtn">更新</button>
			</div>
		</div>
	</div>
</div>

<!-- 查看broker限速详情 -->
<div id="brokerRateLimitModal" class="modal fade" tabindex="-1" data-width="400" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title"><span id="brokerRateLimitAddr"></span>限速详情</h4>
				<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">&times;</button>
			</div>
			<div id="brokerRateLimitDetail" class="modal-body">
			</div>
		</div>
	</div>
</div>

<!-- 修改topic限速 -->
<div id="topicRateLimitModal" class="modal fade" tabindex="-1" data-width="400" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title"><span id="rateLimitTopic"></span>限速修改</h4>
				<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body">
				<form class="form-horizontal form-row-stripped">
					<div class="col-md-12">
						<div class="form-group row justify-content-center">
							<label class="col-form-label col-md-3"> 写入限速: </label>
							<div class="col-md-5 input-group">
								<input type="text" id="rateLimitTopicQps" class="form-control">
								<div class="input-group-append">
									<span class="input-group-text">次/秒</span>
								</div>
							</div>
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" data-dismiss="modal" class="btn btn-light" >取消</button>
				<button type="button" class="btn btn-primary" onclick="updateTopicLimitRate()"
						id="updateTopicLimitRateBtn">确定</button>
			</div>
		</div>
	</div>
</div>

<!-- 查看broker限速详情 -->
<div id="timerWheelMetricsModal" class="modal fade" tabindex="-1" data-width="400" aria-hidden="true" style="max-height: 600px">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title"><span id="brokerRateLimitAddr"></span>时间轮指标详情</h4>
				<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body card-body table-responsive p-0">
				<table class="table table-head-fixed text-nowrap" style="margin-top: 0px">
					<thead>
					<tr>
						<th>序号</th>
						<th>topic</th>
						<th>消息量</th>
						<th>更新时间</th>
					</tr>
					</thead>
					<tbody id="timerWheelMetricsDetail">
						<tr class="no_more_data"><td class="text-center" colspan="4">数据加载中...</td></tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>

<script>

$(function () {
	$('#sourceIp').selectpicker({
		width: '200px'
	});
	$('#destIp').selectpicker({
		width: '200px'
	});
	$('#addNewBroker').smartWizard({
		selected: -1,
		theme: 'dots',
		justified: true,
		autoAdjustHeight: false,
		enableUrlHash: false,
		backButtonSupport: false, // Enable the back button support
		toolbar: {
			position: 'none'
		},
		anchor: {
			enableNavigation: false,
		}
	});
	$('#updateBroker').smartWizard({
		selected: -1,
		theme: 'dots',
		justified: true,
		autoAdjustHeight: false,
		enableUrlHash: false,
		backButtonSupport: false, // Enable the back button support
		toolbar: {
			position: 'none'
		},
		anchor: {
			enableNavigation: false,
		}
	});
	$('#migrateToBroker').smartWizard({
		selected: -1,
		theme: 'dots',
		justified: true,
		autoAdjustHeight: false,
		enableUrlHash: false,
		backButtonSupport: false, // Enable the back button support
		toolbar: {
			position: 'none'
		},
		anchor: {
			enableNavigation: false,
		}
	});
})

	
var installId = "";
var upgradeId = "";
var method = "";
/**
 * 安装broker
 */
function install(id){
	installId = id;
	if(!$('#'+id+'ServerSelect').val()){
		alert("请先选择服务器");
		return;
	}
	if("broker" == id){
		if(!$('#brokerName').val()){
			alert("请填写brokerName");
			return;
		}
		if(!$('input[name="brokerRole"]').is(":checked")){
			alert("请选择broker角色");
			return;
		}
		if($('#listenPort').length > 0 && !$('#listenPort').val()){
			alert("请填写监听端口");
			return;
		}
		if($('input[name="flushDiskType"]').length > 0 && !$('input[name="flushDiskType"]').is(":checked")){
			alert("请选择刷盘方式");
			return;
		}
		if($('#fileReservedTime').length > 0 && !$('#fileReservedTime').val()){
			alert("请填写数据保留时间");
			return;
		}
		var baseDir = $('#baseDir').val();
		if(!baseDir || baseDir.charAt(baseDir.length-1) != "/" || baseDir.charAt(0) != "/"){
			alert("请填写安装的绝对路径，并以/结尾");
			return;
		}
	}
	if($('#'+id+'Install').html() == "继续"){
		setTimeout(method+'()', 500);
	} else {
		validateJDK();
	}
	disableBtn("installBtn");
}

function confirmEnding(str, target) {
	var start = str.length-target.length;
	var arr = str.substr(start,target.length);
	if(arr == target){
		return true;
	}
	return false;
}

/**
 * 升级broker
 */
function upgrade(id) {
	upgradeId = id;
	if($('#'+id+'Key').html() == "继续"){
		setTimeout(method+'()', 500);
	} else {
		upgradeBackup();
	}
	disableBtn("upgradeBtn");
}

/**
 * 升级broker,第一步: 备份数据
 */
function upgradeBackup(){
	active_smartwizard("updateBroker", 0);
	$.post('${request.contextPath}/admin/deploy/backup',
			$("#"+upgradeId).serialize(),
			function(data){
				if(data.status == 200){
					complete_smartwizard("updateBroker", 0);
					// 下载安装包
					setTimeout('upgradeScp()', 1000);
				} else {
					toastr.error("备份数据出错！"+data.message);
					warn_smartwizard("updateBroker", 0);
					upgradeGoOn("upgradeBackup");
				}
			}, 'json');
}

/**
 * 升级broker,第二步: 下载安装包
 */
function upgradeScp(){
	active_smartwizard("updateBroker", 1);
	$.post('${request.contextPath}/admin/deploy/scp',
			$("#"+upgradeId).serialize(),
			function(data){
				if(data.status == 200){
					complete_smartwizard("updateBroker", 1);
					// 解压文件
					setTimeout('upgradeUnzip()', 1000);
				} else {
					toastr.error("下载失败！"+data.message);
					warn_smartwizard("updateBroker", 1);
					upgradeGoOn("upgradeScp");
				}
			}, 'json');
}
/**
 * 升级broker,第三步: 解压最新安装包到安装目录下
 */
function upgradeUnzip(){
	active_smartwizard("updateBroker", 2);
	$.post('${request.contextPath}/admin/deploy/unzip',
			$("#"+upgradeId).serialize(),
			function(data){
				if(data.status == 200){
					complete_smartwizard("updateBroker", 2);
					// 恢复数据
					setTimeout('upgradeRecover()', 1000);
				} else {
					toastr.error("解压失败！"+data.message);
					warn_smartwizard("updateBroker", 2);
					upgradeGoOn("upgradeUnzip");
				}
			}, 'json');
}

/**
 * 升级broker,第四步: 恢复数据
 */
function upgradeRecover(){
	active_smartwizard("updateBroker", 3);
	$.post('${request.contextPath}/admin/deploy/recover',
			$("#"+upgradeId).serialize(),
			function(data){
				if(data.status == 200){
					complete_smartwizard("updateBroker", 3);
					if(confirm("升级成功，是否直接启动？")){
						// 启动broker
						upgradeStartup();
					} else {
						upgradeGoOn("upgradeStartup");
					}
				} else {
					toastr.error("恢复数据出错！"+data.message);
					warn_smartwizard("updateBroker", 3);
					upgradeGoOn("upgradeRecover");
				}
			}, 'json');
}

/**
 * 升级broker,第五步: 启动实例
 */
function upgradeStartup(){
	active_smartwizard("updateBroker", 4);
	$.post('${request.contextPath}/admin/deploy/startup',
			$("#"+upgradeId).serialize(),
			function(data){
				if(data.status == 200){
					complete_smartwizard("updateBroker", 4);
					// 检测进程
					setTimeout('upgradeCheckProgram()', 10000);
				} else {
					toastr.error("启动失败！"+data.message);
					warn_smartwizard("updateBroker", 4);
					upgradeGoOn("upgradeStartup");
				}
			}, 'json');
}
/**
 * 升级broker,第六步: 检测启动的进程
 */
function upgradeCheckProgram(){
	active_smartwizard("updateBroker", 5);
	$.post('${request.contextPath}/admin/deploy/check/program',
			$("#"+upgradeId).serialize(),
			function(data){
				if(data.status == 200){
					$("#"+upgradeId+"ProgramInfo").attr("rows", 5).html(data.result);
					complete_smartwizard("updateBroker", 5);
					alert("恭喜，升级完成啦！请及时刷新页面");
				} else {
					toastr.error("检查启动进程失败！"+data.message);
					warn_smartwizard("updateBroker", 5);
					upgradeGoOn("upgradeCheckProgram");
				}
			}, 'json');
}

/**
 * 继续
 */
function goOn(m){
	$("#"+installId+"Install").html("继续");
	enableBtn("installBtn");
	method = m;
}

/**
 * broker升级,继续
 */
function upgradeGoOn(m){
	$("#"+upgradeId+"Key").html("继续");
	enableBtn("upgradeBtn");
	method = m;
}

/**
 * 校验jdk
 */
function validateJDK(){
	active_smartwizard("addNewBroker", 1);
	$.get('${request.contextPath}/admin/deploy/check/jdk',
		$("#"+installId).serialize(),
        function(data){
            if(data.status == 200){
            	var version = data.result.substring(0, 3);
            	if(version >= 1.8){
            		complete_smartwizard("addNewBroker", 1);
            		// 校验端口
            		setTimeout('checkPort()', 1000);
            	} else {
            		alert("jdk环境校验失败，最低为1.8，目前版本为："+data.result);
            		warn(wizardId);
            		goOn("validateJDK");
            	}
		    }else{
		    	toastr.error("数据获取失败！"+data.message);  
		    	warn_smartwizard("addNewBroker", 1);
		    	goOn("validateJDK");
		    }
       }, 'json');
}
/**
 * 端口校验
 */
function checkPort(){
	active_smartwizard("addNewBroker", 2);
	$.post('${request.contextPath}/admin/deploy/check/port',
		$("#"+installId).serialize(),
        function(data){
            if(data.status == 200){
            	complete_smartwizard("addNewBroker", 2);
            	// 校验目录
            	setTimeout('checkDir()', 1000);
		    } else if(data.status == 500){
		    	toastr.error("端口被该程序占用："+data.result);  
		    	warn_smartwizard("addNewBroker", 2);
		    	goOn("checkPort");
		    } else {
		    	toastr.error("校验失败！"+data.message);
				warn_smartwizard("addNewBroker", 2);
		    	goOn("checkPort");
		    }
       }, 'json');
}

/**
 * 目录校验
 */
function checkDir(){
	active_smartwizard("addNewBroker", 3);
	$.post('${request.contextPath}/admin/deploy/check/dir',
		$("#"+installId).serialize(),
        function(data){
            if(data.status == 200){
            	complete_smartwizard("addNewBroker", 3);
            	// 下载文件
        		setTimeout('scp()', 1000);
		    } else {
		    	toastr.error("校验失败！"+data.message);  
		    	warn_smartwizard("addNewBroker", 3);
		    	goOn("checkDir");
		    }
       }, 'json');
}
/**
 * scp
 */
function scp(){
	active_smartwizard("addNewBroker", 4);
	$.post('${request.contextPath}/admin/deploy/scp',
		$("#"+installId).serialize(),
        function(data){
            if(data.status == 200){
            	complete_smartwizard("addNewBroker", 4);
            	// 解压文件
        		setTimeout('unzip()', 1000);
		    } else {
		    	toastr.error("下载失败！"+data.message);  
		    	warn_smartwizard("addNewBroker", 4);
		    	goOn("scp");
		    }
       }, 'json');
}
/**
 * 解压
 */
function unzip(){
	active_smartwizard("addNewBroker", 5);
	$.post('${request.contextPath}/admin/deploy/unzip',
		$("#"+installId).serialize(),
        function(data){
            if(data.status == 200){
            	complete_smartwizard("addNewBroker", 5);
            	// 配置
        		setTimeout('config()', 1000);
		    } else {
		    	toastr.error("解压失败！"+data.message);  
		    	warn_smartwizard("addNewBroker", 5);
		    	goOn("unzip");
		    }
       }, 'json');
}
/**
 * 配置
 */
function config(){
	active_smartwizard("addNewBroker", 6);
	$.post('${request.contextPath}/admin/deploy/config/' + installId,
		$("#"+installId).serialize(),
        function(data){
            if(data.status == 200){
            	complete_smartwizard("addNewBroker", 6);
            	if("ns" == installId){
	            	// 启动
	        		setTimeout('startup()', 1000);
            	}else{
            		// 初始化配置
            		setTimeout('initConfig()', 1000);
            	}
            		
		    } else {
		    	toastr.error("配置失败！"+data.message);  
		    	warn_smartwizard("addNewBroker", 6);
		    	goOn("config");
		    }
       }, 'json');
}
/**
 * 初始化配置
 */
function initConfig(){
	active_smartwizard("addNewBroker", 7);
	$.post('${request.contextPath}/admin/deploy/config/init',
		$("#"+installId).serialize(),
        function(data){
            if(data.status == 200){
            	complete_smartwizard("addNewBroker", 7);
            	if(confirm("配置成功，是否直接启动？")){
            		startup();
            	} else {
        			goOn("startup");
            	}
		    } else {
		    	toastr.error("初始化配置失败！"+data.message);  
		    	warn_smartwizard("addNewBroker", 7);
		    	goOn("initConfig");
		    }
       }, 'json');
}
/**
 * 启动实例
 */
function startup(){
	active_smartwizard("addNewBroker", 8);
	$.post('${request.contextPath}/admin/deploy/startup',
		$("#"+installId).serialize(),
        function(data){
            if(data.status == 200){
            	complete_smartwizard("addNewBroker", 8);
            	var time = 5000;
            	if("broker" == installId){
            		time = 10000;
            	}
            	// 检测进程
        		setTimeout('checkProgram()', time);
		    } else {
		    	toastr.error("启动失败！"+data.message);  
		    	warn_smartwizard("addNewBroker", 8);
		    	goOn("startup");
		    }
       }, 'json');
}
/**
 * 检测启动的进程
 */
function checkProgram(){
	active_smartwizard("addNewBroker", 9);
	$.post('${request.contextPath}/admin/deploy/check/program',
		$("#"+installId).serialize(),
        function(data){
            if(data.status == 200){
            	$("#"+installId+"ProgramInfo").attr("rows", 5).html(data.result);
            	complete_smartwizard("addNewBroker", 9);
            	alert("恭喜你，安装完成啦！");
            	$("#"+installId+"Install").parent().attr("disabled", "disabled");
		    } else {
		    	toastr.error("检查失败！"+data.message);  
		    	warn_smartwizard("addNewBroker", 9);
		    	goOn("checkProgram");
		    }
       }, 'json');
}
function addBroker(brokerName, version){
	$.get('${request.contextPath}/admin/broker/cluster/config',{
			cid: ${response.result.selectedMQCluster.id}
			}, function(data){
	            $("#clusterConfigBody").html(data);
	            $("#brokerClusterName").val('${response.result.selectedMQCluster.name}').attr("readonly","readonly");
	    		$("#brokerIP1").attr("readonly","readonly");
	    		$("#brokerIP2").attr("readonly","readonly");
	    		$("#storePathRootDir").attr("readonly","readonly");
	    		$("#storePathCommitLog").attr("readonly","readonly");
				$("#brokerName").bind('input propertychange', function(){
					if(brokerName){
						$("#dir").val($("#baseDir").val()+$("#brokerName").val() + "-s" + $("#brokerId").val());
					} else {
						$("#dir").val($("#baseDir").val()+$("#brokerName").val());
					}
					$("#realPath").html($("#dir").val());
	    			$("#storePathRootDir").val($("#dir").val()+"/data");
	    			$("#storePathCommitLog").val($("#dir").val()+"/data/commitlog");
				});
				$("#baseDir").bind('input propertychange', function(){
					if(brokerName){
						$("#dir").val($("#baseDir").val()+$("#brokerName").val() + "-s" + $("#brokerId").val());
					} else {
						$("#dir").val($("#baseDir").val()+$("#brokerName").val());
					}
					$("#realPath").html($("#dir").val());
	    			$("#storePathRootDir").val($("#dir").val()+"/data");
	    			$("#storePathCommitLog").val($("#dir").val()+"/data/commitlog");
				});
				$("#brokerId").bind('input propertychange', function(){
					if(brokerName){
						$("#dir").val($("#baseDir").val()+$("#brokerName").val() + "-s" + $("#brokerId").val());
					} else {
						$("#dir").val($("#baseDir").val()+$("#brokerName").val());
					}
					$("#realPath").html($("#dir").val());
					$("#storePathRootDir").val($("#dir").val()+"/data");
					$("#storePathCommitLog").val($("#dir").val()+"/data/commitlog");
				});
	    		if(!$("#rmqAddressServerDomain").val()){
		    		$("#rmqAddressServerDomain").val('${mqcloudDomain}').attr("readonly","readonly");
	    		}
	    		if(!$("#rmqAddressServerSubGroup").val()){
		    		$("#rmqAddressServerSubGroup").val('nsaddr-${response.result.selectedMQCluster.id}').attr("readonly","readonly");
	    		}
	    		if(brokerName){
	    			$("#brokerName").val(brokerName);
	    			$("#brokerName").attr("readonly","readonly");
					$("#brokerId").val(1);
	    			// 设置路径
	    			$("#dir").val($("#baseDir").val()+brokerName+"-s" + $("#brokerId").val());
	    			$("#realPath").html($("#dir").val());
	    			$("#storePathRootDir").val($("#dir").val() + "/data");
	    			$("#storePathCommitLog").val($("#dir").val() + "/data/commitlog");
	    			
	    			$('input[name="brokerRole"]').each(function(){
	    				if($(this).val() == 'ASYNC_MASTER' || $(this).val() == 'SYNC_MASTER'){
	    					$(this).next().remove();
	    					$(this).remove();
	    				} else {
	    					$(this).attr("checked", "checked");
	    				}
	    			});
	    		} else {
	    			$("#brokerId").attr("readonly","readonly");
	    			$('input[name="brokerRole"]').each(function(){
	    				if($(this).val() == 'SLAVE'){
	    					$(this).next().remove();
	    					$(this).remove();
	    				}
	    			});
	    		}
	            $('[data-tooltip="true"]').tooltip({
		            container: 'body'
		        });
    		}
	);
	initServerList("brokerServerSelect");
	initBrokerVersion(version)
}

function initBrokerVersion(version) {
	if (version == undefined) {
		return;
	}
	if (is_broker_5Level(version)) {
		$("#version_5").attr('checked', 'true');
	} else {
		$("#version_4").attr('checked', 'true');
	}
}

function upgradeBroker(brokerAddr, brokerName, baseDir) {
    $("#upgradeBrokerAddr").val(brokerAddr);
	$("#upgradeBrokerName").val(brokerName);
	$("#upgradeBrokerIp").val(brokerAddr.split(":")[0]);
	$("#upgradeBrokerListenPort").val(brokerAddr.split(":")[1]);
	$("#upgradeDir").val(baseDir);
}

function migrateBrokerData(brokerAddr, brokerName) {
	if(brokerAddr){
		var ip = brokerAddr.split(":")[0];		  
		$("#sourceIp").html('<option selected="selected" value="'+ ip +'">'+ ip +'</option>');
		$('#sourceIp').selectpicker('refresh');
		$("#sourceHome").val(brokerName).attr("readonly", "readonly");
	} else {
		initServerList("sourceIp");
	}
	initServerList("destIp");
}

/**
 * 初始化server下拉列表
 */
function initServerList(componentId){
	$.get('${request.contextPath}/admin/server/all',
	        function(data){
	            if(data.status == 200){
	            	var content = "";
	            	for(var i in data.result){
	            		var server = data.result[i];
	            		content += "<option value='"+server.ip+"'>"+server.ip+"</option>";
	            	}
	        		$("#"+componentId).html(content);
	        		$("#"+componentId).selectpicker('refresh');
			    }else{
			    	toastr.error("数据获取失败！"+data.message);  
			    }
        }, 'json');
}
/**
 * 停写
 */
function nowrite(formId){
	disable(formId+"Btn");
	$.post('${request.contextPath}/admin/cluster/nowrite',
			$("#"+formId).serialize(),
	        function(data){
	            if(data.status == 200){
	            	toastr.success("停写成功，请耐心等待客户端写入结束！");
					reload(3000);
			    }else{
			    	toastr.error("操作失败！"+data.message);  
			    	enable(formId+"Btn");
			    }
        }, 'json');
}

/**
 * 恢复写入
 */
function resumeWrite(formId){
	disable(formId+"Btn");
	$.post('${request.contextPath}/admin/cluster/resume/write',
			$("#"+formId).serialize(),
			function(data){
				if(data.status == 200){
					toastr.success("恢复成功，请耐心等待客户端恢复写入！");
					reload(3000);
				}else{
					toastr.error("操作失败！"+data.message);
					enable(formId+"Btn");
				}
			}, 'json');
}

/**
 * 获取进程信息
 */
function program(addr, programId){
	$.get('${request.contextPath}/admin/deploy/program',
			{
				addr: addr
			},
	        function(data){
				$("#"+programId).html(data.result);
        }, 'json');
}

/**
 * 下线
 */
function brokerOffline(formId){
	disable(formId+"Btn");
	$.post('${request.contextPath}/admin/deploy/_shutdown',
			$("#"+formId).serialize(),
	        function(data){
	            if(data.status == 200){
	            	toastr.success("下线成功");  
	            	reload(3000);
			    }else{
			    	toastr.error("操作失败！"+data.message);  
			    	enable(formId+"Btn");
			    }
        }, 'json');
}
$('#mqClusterSelect').on('change',function(){
	window.location.href = "${request.contextPath}/admin/cluster/list?cid="+$(this).val();
});

$(function(){
	// broker server select change
	$('#brokerServerSelect').on('shown.bs.select', function(e) {
		active_smartwizard("addNewBroker", 0);
		
	});
	$('#brokerServerSelect').on('hidden.bs.select', function(e) {
		if(!$('#brokerServerSelect').val()){
			disable_smartwizard("addNewBroker", 0);
		} else {
			complete_smartwizard("addNewBroker", 0);
		}
	});
	$('#brokerServerSelect').on('changed.bs.select', function(e) {
		$("#brokerIP1").val($(this).val());
		$("#brokerIP2").val($(this).val());
	});
	
	// fix bootstrap model & highcharts resize
	$('#brokerTrafficModal').on('shown.bs.modal', function() {
		brokerTraffic();
	});
	
	// cluster traffic
	lineChart("cluster", function (){
		$("#clusterId").val("${response.result.selectedMQCluster.id}");
	});
	
	<#if RequestParameters.ip?? && RequestParameters.ip != "">
		setIp("${RequestParameters.ip}");
		$('#brokerTrafficModal').modal('show');
	</#if>
	
	// fix bootstrap model & highcharts resize
	$('#brokerStoreStatModal').on('shown.bs.modal', function() {
		lineChart("broker_store", function (){
			$("#brokerIp").val(brokerIp);
		});
	});
	
	<#if RequestParameters.brokerStoreIp?? && RequestParameters.brokerStoreIp != "">
		showBrokerStoreStatModal('${RequestParameters.brokerStoreIp}');
	</#if>
	
	// migrate server select change
	$('#destIp').on('shown.bs.select', function(e) {
		active("migrateServer");
	});
	$('#destIp').on('hidden.bs.select', function(e) {
		if(!$('#destIp').val()){
			disableStep("migrateServer");
		} else {
			complete("migrateServer");
		}
	});
});

function warn(id){
	$("#"+id).addClass("warn");
}
function disableStep(id){
	$("#"+id).removeClass("active").addClass("disabled");
}
function active(id){
	$("#"+id).removeClass("disabled").removeClass("warn").addClass("active");
}
function complete(id){
	$("#"+id).removeClass("active").removeClass("warn").addClass("complete");
}
function disableBtn(id){
	$("#"+id).attr("disabled", "disabled");
}
function enableBtn(id){
	$("#"+id).removeAttr("disabled");
}

function active_smartwizard(content, index) {
	$('#'+ content).smartWizard("goToStep", index);
}

function complete_smartwizard(content, index) {
	$('#'+ content).smartWizard("unsetState", [index], "warning");
	$('#'+ content).smartWizard("setState", [index], "done");
}

function warn_smartwizard(content, index) {
	$('#'+ content).smartWizard("setState", [index], "warning");
}

function disable_smartwizard(content, index) {
	$('#'+ content).smartWizard("setState", [index], "disable");
}

var brokerIp;
function setIp(ip){
	brokerIp = ip;
	$("#brokerTrafficChart").empty();
}

/**
 * 获取broker流量图
 */
function brokerTraffic(){
	$.get('${request.contextPath}/admin/cluster/traffic',
		{
		ip: brokerIp
		},
        function(data){
            $("#brokerTrafficChart").html(data);
    });	
}

/**
 * 初始化topic
 */
function initTopic(){
	if (!confirm("你确定要将该集群的topic存储到表中?")) {
		return;
	}
	$("#initBody").empty();
	$("#initDiv").html("topic");
	post('${request.contextPath}/admin/cluster/init/topic',
		{
		cid: ${response.result.selectedMQCluster.id}
		},
        function(data){
			$("#initBody").html(data);
			$('#initModal').modal('show');
    });	
}

/**
 * 初始化consumer
 */
function initConsumer(){
	if (!confirm("你确定要将该集群的消费者存储到表中?")) {
		return;
	}
	$("#initBody").empty();
	$("#initDiv").html("consumer");
	post('${request.contextPath}/admin/cluster/init/consumer',
		{
		cid: ${response.result.selectedMQCluster.id}
		},
        function(data){
			$("#initBody").html(data);
			$('#initModal').modal('show');
    });	
}
// 与nameserver同步 broker
function refresh(){
	if (!confirm("你确定要从NameServer刷新broker吗?")) {
		return;
	}
	post('${request.contextPath}/admin/broker/refresh',
		{
			cid: ${response.result.selectedMQCluster.id}
		},
        function(data){
            if(data.status == 200){
				toastr.success("抓取成功，将自动刷新");  
				reload(3000);
		    }else{
		    	toastr.error("抓取失败！"+data.message);
		    }
        }, 'json');
}

// 延时消息搜索
var pageNum = 0;
//显示分页
function showPage(num){
	pageNum = num;
	var comp = $("#data_"+num);
	var size = comp.attr("data_size");
	var search = comp.attr("data_search");
	var left = comp.attr("data_left");
	$("#pageNum").html(num);
	$("#sizeNum").html(size);
	$("#searchNum").html(search);
	$("#leftNum").html(left);
	$("#pager").show();
	if(num == 1){
		$("#previous").addClass("disabled");
	} else {
		$("#previous").removeClass("disabled");
	}
	if(left > 0){
		$("#next").removeClass("disabled");
	} else {
		$("#next").addClass("disabled");
	}
	// 展示数据
	$("#page_"+pageNum).show().siblings("tbody").hide();
}
//上一页
function previous(){
	if(!$("#previous").hasClass("disabled")){
		showPage(pageNum - 1);
	}
}
//下一页
function next(){
	if(!$("#next").hasClass("disabled")){
		if($("#data_"+(pageNum+1)).length > 0){
			showPage(pageNum+1);
		} else {
			searchOffsetMessage(true);
		}
	}
}

function showDelayMessageModal(delay, curOffset, maxOffset, toBrokerName, toQueue){
	$("#offsetStart").val(curOffset);
	$("#offsetEnd").val(maxOffset);
	$("#toBrokerName").val(toBrokerName);
	$("#toQueue").val(toQueue);
	$("#delayLevel").html(delay);
	$("#dataTable tbody").remove();
	$("#dataTable input").remove();
	searchOffsetMessage(false);
	$("#delayMessageModal").modal('show');
}

//偏移量消息搜索
function searchOffsetMessage(append){
	$("#append").val(append);
	post('${request.contextPath}/topic/message/delay/offset/search', $("#msgSearchForm").serialize(), function(data){
		if(!append){
			$("#dataTable tbody").remove();
			$("#dataTable input").remove();
		}
       	$("#dataTable").append(data);
    });
}

function showBrokerStoreStatModal(ip){
	$("#ipBroker").html(ip);
	setIp(ip);
	$("#brokerStoreStatModal").modal('show');
}

function showBrokerConfigModal(addr){
	$("#brokerAddr").html(addr);
	post('${request.contextPath}/admin/broker/online/config',
		{
		cid: ${response.result.selectedMQCluster.id},
	    addr:  addr
		},
        function(data){
			$("#brokerConfigBody").html(data);
			$('[data-tooltip="true"]').tooltip({
	            container: 'body'
	        });
			$("#brokerConfigModal").modal('show');
    });	
}

const fileReservedTime = [];
const timerRollWindowSlot = [];

function modifyBrokerConfig(){
	var tip = "";
	var needReboot = false;
	var configParam = "";
	$("#brokerConfigBody input:text").each(function(){
		var nowValue = $.trim($(this).val());
		var prevValue = $(this).attr("data");
		var optionName = $(this).attr("name");
		if (optionName == "fileReservedTime") {
			fileReservedTime[0] = nowValue;
		} else if (optionName == "timerRollWindowSlot") {
			timerRollWindowSlot[0] = prevValue;
			timerRollWindowSlot[1] = nowValue;
		}
		if(nowValue != prevValue){
			if($(this).attr("dynamic") == "false"){
				needReboot = true;
			}
			tip += optionName + "修改为" + nowValue + "\n";
			configParam += $(this).attr("name") + ":" + nowValue + ";";
		}
	})
	if (fileReservedTime.length > 0 || timerRollWindowSlot.length > 0) {
		var fileReservedTimeValue = fileReservedTime[0];
		if (fileReservedTime.length == 0){
			fileReservedTimeValue = 72;
		}
		fileReservedTimeValue = fileReservedTimeValue * 3600;
		var timerRollWindowSlotOldValue = timerRollWindowSlot[0];
		var timerRollWindowSlotNewValue = timerRollWindowSlot[1];
		if (timerRollWindowSlot.length == 0){
			timerRollWindowSlotOldValue = 86400;
			timerRollWindowSlotNewValue = 86400;
		}
		timerRollWindowSlot.length = 0;
		fileReservedTime.length = 0;
		if (timerRollWindowSlotNewValue > fileReservedTimeValue) {
			alert("fileReservedTime配置值必须大于timerRollWindowSlot配置值, 否则可能造成定时消息丢失");
			return;
		}
		if (timerRollWindowSlotOldValue != timerRollWindowSlotNewValue && timerRollWindowSlotOldValue > fileReservedTimeValue){
			alert("当前fileReservedTime配置值必须大于timerRollWindowSlot修改前的旧值, 否则可能造成定时消息丢失");
			return;
		}
	}
	$("#brokerConfigBody input:radio:checked").each(function(){
		var nowValue = $.trim($(this).val());
		var prevValue = $(this).attr("data");
		if(nowValue != prevValue){
			if($(this).attr("dynamic") == "false"){
				needReboot = true;
			}
			tip += $(this).attr("name") + "修改为" + nowValue + "\n";
			configParam += $(this).attr("name") + ":" + nowValue + ";";
		}
	})
	if(tip){
		if(needReboot){
			tip += "由于修改了不支持动态修改的项，请更新后重启broker";
		}
		if(confirm(tip)){
			disable("modifyBrokerConfigBtn");
			$.get('${request.contextPath}/admin/broker/update/online/config',
					{
					cid: ${response.result.selectedMQCluster.id},
				    addr:  $("#brokerAddr").html(),
				    config: configParam
					},
			        function(data){
						if(data.status == 200){
			            	toastr.success("操作成功！即将刷新页面！");  	            	
			            	reload(2000);            	
					    }else{
					    	toastr.error("操作失败！"+data.message);  
					    	enable("modifyBrokerConfigBtn");
					    }
			    });	
		}
	} else {
		alert("没有改动，无需更新");
	}
}
/**
 * 启动实例
 */
function startupBroker(ipAddr, brokerName, dir){
	disable(brokerName+"Btn");
	$.post('${request.contextPath}/admin/deploy/startup/broker',{
		ipAddr: ipAddr,
		dir: dir
		},function(data){
            if(data.status == 200){
            	toastr.success("启动成功！即将刷新页面！");  	            	
            	reload(5000);   
		    } else {
		    	toastr.error("启动失败！"+data.message);  
		    	enable(brokerName+"Btn");
		    }
       }, 'json');
}

/**
 * 迁移broker数据
 */
function migrate(){
	if(!$('#sourceIp').val()){
		alert("请选择源服务器");
		return;
	}
	if(!$('#sourceHome').val()){
		alert("请填写源broker绝对路径");
		return;
	}
	if($('#sourceHome').val().indexOf("/") != 0){
		alert("源broker的安装路径不是绝对路径!");
		return;
	}
	if(!$('#destIp').val()){
		alert("请选择目标服务器");
		return;
	}
	if($('#destIp').val() == $("#sourceIp").val()){
		alert("源服务器不能与目标服务器相同");
		return;
	}
	if(!$('#destHome').val()){
		alert("请填写目标broker绝对路径");
		return;
	}
	if($('#destHome').val().indexOf("/") != 0){
		alert("目标broker的安装路径不是绝对路径!");
		return;
	}
	if($('#migrateBtn').html() == "继续"){
		setTimeout(method+'()', 500);
	} else {
		checkDestDir();
	}
	disableBtn("migrateBtn");
}

/**
 * 继续
 */
function migrateGoOn(m){
	$("#migrateBtn").html("继续");
	enableBtn("migrateBtn");
	method = m;
}
/**
 * 数据迁移第一步：目录校验
 */
function checkDestDir(){
	active_smartwizard("migrateToBroker", 1);
	$.post('${request.contextPath}/admin/deploy/check/dir/exist',
		$("#migrateForm").serialize(),
        function(data){
            if(data.status == 200){
            	complete_smartwizard("migrateToBroker", 1);
        		setTimeout('createStorePath()', 500);
		    } else {
		    	toastr.error("校验失败！"+data.message);  
		    	migrateGoOn("checkDestDir");
		    	warn_smartwizard("migrateToBroker", 1);
		    }
       }, 'json');
}
/**
 * 数据迁移第二步：在目标机器创建数据存储目录
 */
function createStorePath(){
	active_smartwizard("migrateToBroker", 2);
	$.post('${request.contextPath}/admin/deploy/create/store/path',
		$("#migrateForm").serialize(),
        function(data){
            if(data.status == 200){
            	complete_smartwizard("migrateToBroker", 2);
        		setTimeout('authentication()', 500);
		    } else {
		    	toastr.error("创建失败！"+data.message);  
		    	migrateGoOn("createStorePath");
		    	warn_smartwizard("migrateToBroker", 2);
		    }
       }, 'json');
}
/**
 * 数据迁移第三步：机器互信
 */
function authentication(){
	active_smartwizard("migrateToBroker", 3);
	$.post('${request.contextPath}/admin/deploy/authentication',
		$("#migrateForm").serialize(),
        function(data){
            if(data.status == 200){
            	complete_smartwizard("migrateToBroker", 3);
        		setTimeout('getSourceStoreFile()', 500);
		    } else {
		    	toastr.error("互信失败！"+data.message);  
		    	migrateGoOn("authentication");
		    	warn_smartwizard("migrateToBroker", 3);
		    }
       }, 'json');
}
/**
 * 数据迁移第四步：获取源数据文件
 */
function getSourceStoreFile(){
	active_smartwizard("migrateToBroker", 4);
	$.post('${request.contextPath}/admin/deploy/store/file',
		$("#migrateForm").serialize(),
        function(data){
			$("#migrateTable tbody").html(data);
       	}).fail(function(response) {
    	   $("#migrateTable tbody").html("网络错误，请查看后台日志");
    	   migrateGoOn("getSourceStoreFile");
   		   warn_smartwizard("migrateToBroker", 4);
       	});
}
/**
 * 数据迁移第五步：真正文件迁移
 */
function migrateStroreFile(){
	$("#sourceIp").attr("disabled", "disabled");
	$("#sourceHome").attr("disabled", "disabled");
	$("#destIp").attr("disabled", "disabled");
	$("#destHome").attr("disabled", "disabled");
	active_smartwizard("migrateToBroker", 5);
	$("#migrateProgressDiv").addClass("active");
	var trs = $("#migrateTable tr[status='0']");
	if(trs.length != 0) {
		scpStroreFile(trs.eq(0));
	} else {
		active_smartwizard("migrateToBroker", 6);
		$("#migrateProcessBar").width("100%");
		$("#migrateProgressDiv").removeClass("active");
		setTimeout('alert("迁移完成")', 1000);
	}
}

function scpStroreFile(tr){
	var pid = tr.attr("data-tt-parent-id");
	var slashIndex = pid.indexOf("_");
	// 展开二级foler
	if(slashIndex != -1){
		$("#migrateTable").treetable("expandNode", pid.substring(0, slashIndex));
	}
	// 展开父folder
	$("#migrateTable").treetable("expandNode", pid);
	var jsonData = {};
	jsonData.sourceIp = $("#sourceIp").val();
	jsonData.sourceHome = $("#sourceHome").val();
	jsonData.destIp = $("#destIp").val();
	jsonData.destHome = $("#destHome").val();
	jsonData.storeFile = tr.data("json");
    // 大于5M显示load标识
    if(jsonData.storeFile.size > 5242880){
    	tr.find("span.loading").addClass("mqloading");
    }
    // 有滚动条
    if($("#migrateTable").height() > 400){
	    var trOffset = tr.offset().top - $("#migrateDiv").offset().top;
	    // 超过一半，滚动
	    if(trOffset > 200){
	    	//$("#migrateDiv").scrollTop($("#migrateDiv").scrollTop() + trOffset - 200);
	    	$("#migrateDiv").stop(true, true).animate({scrollTop: $("#migrateDiv").scrollTop() + trOffset - 200}, 200);
	    }
    }
	$.ajax({
	    type: 'POST',
	    url: '${request.contextPath}/admin/deploy/scp/storefile',
	    data: JSON.stringify(jsonData),
	    success: function(data) { 
	    	var transferComponent = tr.find(".transComp");
	    	tr.find("span.loading").removeClass("fa-tag").removeClass("mqloading");
            if(data.status == 200){
            	tr.attr('status', '2');
            	transferComponent.removeClass("fa-xmark").addClass("fa-check").attr("data-original-title", "传输成功");
            	var md5Compo = tr.find(".md5Comp");
            	if(data.result.md5OK){
            		md5Compo.addClass("fa-check");
            	} else {
            		md5Compo.addClass("fa-xmark");
            		if(data.result.sourceMD5){
            			md5Compo.attr("data-original-title", data.result.sourceMD5 + "!=" + data.result.destMD5);
            		}
            		var sizeCompo = tr.find(".sizeComp");
            		if(data.result.sizeOK){
            			sizeCompo.addClass("fa-check").attr("data-original-title", "大小相同");
            		} else {
            			sizeCompo.addClass("fa-xmark");
            			if(data.result.sourceSize){
            				sizeCompo.attr("data-original-title", data.result.sourceSize + "!=" + data.result.destSize);
            			}
            		}
            	}
            	// 合并传输的单独处理
            	if(tr.attr("date-type") == 'folder' && data.result.scpVOMap){
            		$("#migrateTable tr[data-tt-parent-id='"+tr.attr("data-tt-id")+"']").each(function(){
            			var file = $(this).find(".dataFile").eq(0).html();
            			var rst = data.result.scpVOMap[file]
            			if(rst){
            				var md5Compo2 = $(this).find(".md5Comp");
            				if(rst.md5OK){
            					md5Compo2.addClass("fa-check");
                        	} else {
                        		md5Compo2.addClass("fa-xmark").attr("data-original-title", rst.sourceMD5 + "!=" + rst.destMD5);
                        		var sizeCompo2 = $(this).find(".sizeComp");
                        		if(rst.sizeOK){
                        			sizeCompo2.addClass("fa-check").attr("data-original-title", "大小相同");
                        		} else {
                        			sizeCompo2.addClass("fa-xmark").attr("data-original-title", rst.sourceSize + "!=" + rst.destSize);
                        		}
                        	}
            			} else {
            				console.error("="+file+"="+data.result.scpVOMap);
            			} 
            		});
            		// 展开folder
            		if(!data.result.md5OK){
	   		    		$("#migrateTable").treetable("expandNode", tr.attr("data-tt-id"));
            		}
            	}
            	scpBytes += data.result.size;
            	var percent = (scpBytes / totalBytes) * 100;
            	$("#migrateProcessBar").width(formatNum(percent) + "%");
				$("#migrateSpeed").html(data.result.humanReadableRate);
				$("#migrated").html(formatSize(scpBytes));
				migrateStroreFile();
		    } else {
		    	toastr.error("传输失败！"+data.message);
		    	migrateGoOn("migrateStroreFile");
		    	warn_smartwizard("migrateToBroker", 5);
		    	$("#migrateProgressDiv").removeClass("active");
		    	transferComponent.addClass("fa-xmark").attr("data-original-title", data.message);
		    	tr.find("span.loading").addClass("fa-tag pointer").attr("data-original-title", "标记为已处理?");
		    	// 展开folder
		    	if(tr.hasClass("branch")){
		    		$("#migrateTable").treetable("expandNode", tr.attr("data-tt-id"));
		    	}
		    }
	    },error : function(XMLHttpRequest, err, e){
			console.log("网络异常("+XMLHttpRequest.status+"):"+err);
			toastr.error("网络异常("+XMLHttpRequest.status+"):"+err);
			var transferComponent = tr.find(".transComp");
			migrateGoOn("migrateStroreFile");
			warn_smartwizard("migrateToBroker", 5);
			$("#migrateProgressDiv").removeClass("active");
			transferComponent.addClass("fa-xmark").attr("data-original-title", data.message);
			tr.find("span.loading").addClass("fa-tag pointer").attr("data-original-title", "标记为已处理?");
			if(tr.hasClass("branch")){
				$("#migrateTable").treetable("expandNode", tr.attr("data-tt-id"));
			}
		},
	    contentType: "application/json",
	    dataType: 'json'
	});
}

function skip(id){
	if($("#" + id).attr("status") == "0"){
		$("#" + id).find(".transComp").removeClass("fa-xmark").addClass("fa-check");
		$("#" + id).attr("status", "2");
		alert($("#" + id).find(".dataFile").eq(0).html()+"标记为已处理");
	}
}

function brokerRateLimitModalShow(addr){
	$("#brokerRateLimitAddr").html(addr);
	post('${request.contextPath}/admin/broker/ratelimit/info',
			{
				cid: ${response.result.selectedMQCluster.id},
				addr:  addr
			},
			function(data){
				$("#brokerRateLimitDetail").html(data);
				$("#brokerRateLimitModal").modal('show');
				$("#rateLimitAddr").val(addr);
				$("#rateLimitCid").val(${response.result.selectedMQCluster.id});
			});
}

function updateBrokerLimitRate() {
	disable("brokerLimitRateFormBtn");
	$.post('${request.contextPath}/admin/broker/ratelimit/update',
			$("#brokerLimitRateForm").serialize(),
			function(data){
				if(data.status == 200){
					toastr.success("修改成功, 系统将自动刷新");
					reload(3000);
				} else{
					toastr.error("修改失败！"+data.message);
					enable("brokerLimitRateFormBtn");
				}
			}, 'json');
}

function updateTopicLimitRateShow(topic, qps) {
	$("#rateLimitTopic").html(topic);
	$("#rateLimitTopicQps").val(qps);
	$("#topicRateLimitModal").modal('show');
}

function updateTopicLimitRate() {
	disable("updateTopicLimitRateBtn");
	$.post('${request.contextPath}/admin/broker/ratelimit/update',
			{
				cid: ${response.result.selectedMQCluster.id},
				addr:  $("#rateLimitAddr").val(),
				topic: $("#rateLimitTopic").html(),
				topicLimitQps: $("#rateLimitTopicQps").val()
			},
			function(data){
				if(data.status == 200){
					toastr.success("修改成功, 系统将自动刷新");
					reload(3000);
				} else{
					toastr.error("修改失败！"+data.message);
					enable("updateTopicLimitRateBtn");
				}
			}, 'json');
}
function hideProxyInput(){
	$("#proxyInput").hide();
}
function showProxyInput(){
	$("#proxyInput").show();
}

function is_broker_5Level(version) {
	if (version) {
		if (version.startsWith("V5")) {
			return true
		}
		return false
	}
	return false
}

function timerWheelMetrics(addr) {
	$.get('${request.contextPath}/admin/broker/timerWheel/metrics',
		{
			cid: ${response.result.selectedMQCluster.id},
			addr:  addr
		},
		function(data){
			$("#timerWheelMetricsDetail").html(data);
		});
}
</script>
</#if>